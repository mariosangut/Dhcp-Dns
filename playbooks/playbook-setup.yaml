---
# ======================================================
# SERVERS CONFIGURATION
# ======================================================
- name: TASK 1. Configuring servers
  hosts: servers
  become: true
  tasks:
    - name: Changing DNS # aÃ±adimos servidor de google para poder resovler los dominios de la instalacion de paquetes
      ansible.builtin.copy:
        src: ../files/resolv.conf
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: "0644" # permisos en octal
        backup: true
        
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    

#======================================================
# GLOBAL CONFIGURATION
# ======================================================
- name: Configuring time-zone and .log
  hosts: all
  become: true
  tasks:
    - name: Synchronize system time
      ansible.builtin.command: timedatectl set-timezone Europe/Madrid
      changed_when: false

    - name: Ensure system clock is synchronized
      ansible.builtin.apt:
        name: chrony
        state: present
        update_cache: false

    - name: Start and enable chrony
      ansible.builtin.systemd:
        name: chronyd
        state: started
        enabled: true

    - name: Install rsyslog
      when: "'servers' in group_names"
      ansible.builtin.apt:
        name: rsyslog
        state: present
        update_cache: false

    - name: Enable and start rsyslog service
      ansible.builtin.systemd:
        name: rsyslog
        enabled: true

#======================================================
# INSTALL ISC-DHCP-SERVER & BIND9 
# ======================================================
# Aunque tengamos un playbook the configuracion, primero instalamos los servicios
# para que a la hora de crear la clave no nos de problemas

- name: Installing DHCP server
  hosts: dhcp
  become: true
  tasks:
    - name: Isc-dhcp-server
      ansible.builtin.apt:
        update_cache: false # Actualizar
        name: isc-dhcp-server
        state: present

- name: Installing dns server
  hosts: dns
  become: true
  tasks:
    - name: Bind9
      ansible.builtin.apt:
        update_cache: false # Actualizar
        name: bind9
        state: present

# ======================================================
# CREATE TSIGG KEY
# ======================================================
- name: Generate TSIG key on DNS
  hosts: dns
  become: true
  tasks:
    - name: Ensure /etc/bind exists
      ansible.builtin.file:
        path: /etc/bind
        state: directory
        owner: bind
        group: bind
        mode: "0755"

    - name: Check if TSIG key already exists
      ansible.builtin.stat:
        path: /etc/bind/ddns.key
      register: tsig_stat

    - name: Generate TSIG key (only if missing)
      ansible.builtin.command: tsig-keygen -a hmac-sha256 ddns-key
      register: tsig_output
      when: not tsig_stat.stat.exists

    - name: Save TSIG key to /etc/bind/ddns.key
      ansible.builtin.copy:
        dest: /etc/bind/ddns.key
        content: "{{ tsig_output.stdout }}"
        owner: bind
        group: bind
        mode: "0600"
      when: not tsig_stat.stat.exists

    - name: Read TSIG key content
      ansible.builtin.slurp:
        src: /etc/bind/ddns.key
      register: slurped_tsig

    - name: Remove old TSIG block if exists
      ansible.builtin.blockinfile:
        path: /etc/bind/named.conf.options
        marker: "# === DDNS KEY BLOCK ==="
        state: absent

    - name: Insert TSIG key block into named.conf.options
      ansible.builtin.blockinfile:
        path: /etc/bind/named.conf.options
        marker: "# === DDNS KEY BLOCK ==="
        block: "{{ slurped_tsig.content | b64decode }}"
      notify: restart bind9
      when: slurped_tsig is defined and slurped_tsig.content | length > 0

  handlers:
    - name: restart bind9
      ansible.builtin.service:
        name: bind9
        state: restarted


- name: Copy TSIG key from DNS to DHCP
  hosts: dhcp
  become: true
  tasks:
    - name: Ensure /etc/dhcp exists
      ansible.builtin.file:
        path: /etc/dhcp
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Fetch TSIG key file from DNS
      ansible.builtin.fetch:
        src: /etc/bind/ddns.key
        dest: /tmp/ddns.key
        flat: true
      delegate_to: dns
      run_once: true

    - name: Copy TSIG key into DHCP directory
      ansible.builtin.copy:
        src: /tmp/ddns.key
        dest: /etc/dhcp/ddns.key
        owner: root
        group: root
        mode: "0600"

# ======================================================
# DNS SERVER CONFIGURATION
# ======================================================
- name: Configuring DNS server
  hosts: dns
  become: true
  tasks:

    - name: Configuring local zones file
      ansible.builtin.copy:
        src: ../files/dns/named.conf.local
        dest: /etc/bind/named.conf.local
        owner: root
        group: bind
        mode: "0640"
        backup: true

    - name: Configuring direct zone file
      ansible.builtin.copy:
        src: ../files/dns/db.mario.test
        dest: /var/lib/bind/db.mario.test
        owner: root
        group: bind
        mode: "0644"  
        backup: true

    - name: Configuring reverse zone file
      ansible.builtin.copy:
        src: ../files/dns/db.192
        dest: /var/lib/bind/db.192
        owner: root
        group: bind
        mode: "0644" 
        backup: true

    # ---- PERMISOS -----
    - name: Ensure correct permissions on /var/lib/bind directory
      ansible.builtin.file:
        path: /var/lib/bind
        owner: root
        group: bind
        mode: "2750"
        state: directory

    # estos dos aseguran que nada rompe DDNS
    - name: Ensure correct permissions on direct zone file
      ansible.builtin.file:
        path: /var/lib/bind/db.mario.test
        owner: root
        group: bind
        mode: "0644"

    - name: Ensure correct permissions on reverse zone file
      ansible.builtin.file:
        path: /var/lib/bind/db.192
        owner: root
        group: bind
        mode: "0644"

    # ---- VALIDATIONS -----
    - name: Validate named configuration
      ansible.builtin.command: named-checkconf

    - name: Validate direct zone
      ansible.builtin.command: named-checkzone "mario.test" /var/lib/bind/db.mario.test

    - name: Validate reverse zone
      ansible.builtin.command: named-checkzone "58.168.192.in-addr.arpa" /var/lib/bind/db.192

    - name: Enabling the service and restarting the service
      ansible.builtin.systemd:
        name: bind9
        state: restarted
        enabled: true

# ======================================================
# DHCP SERVER CONFIGURATION
# ======================================================
- name: Configuring DHCP server
  hosts: dhcp
  become: true
  tasks:
    - name: Configuring listen network adapter
      ansible.builtin.copy:
        src: ../files/dhcp/listen
        dest: /etc/default/isc-dhcp-server
        owner: root
        group: root
        mode: "0644" 
        backup: true

    - name: Configuring dhcpd.conf file
      ansible.builtin.copy:
        src: ../files/dhcp/dhcpd.conf
        dest: /etc/dhcp/dhcpd.conf
        owner: root
        group: root
        mode: "0644"
        backup: true

    - name: Validate dhcpd.conf
      ansible.builtin.command: dhcpd -t -cf /etc/dhcp/dhcpd.conf

    - name: Enabling the service and restarting the service
      ansible.builtin.systemd:
        name: isc-dhcp-server
        state: restarted
        enabled: true

