---
# ======================================================
# SERVERS CONFIGURATION
# ======================================================
- name: TASK 1. Configuring servers
  hosts: servers
  become: true
  tasks:
    - name: Changing DNS (Google DNS for package installation)
      ansible.builtin.copy:
        src: ../files/resolv.conf
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: "0644"
        backup: true
        
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

# ======================================================
# GLOBAL CONFIGURATION
# ======================================================
- name: Configuring time-zone and system logs
  hosts: all
  become: true
  tasks:
    - name: Synchronize system time
      ansible.builtin.command: timedatectl set-timezone Europe/Madrid
      changed_when: false

    - name: Install chrony (NTP sync)
      ansible.builtin.apt:
        name: chrony
        state: present

    - name: Start and enable chronyd
      ansible.builtin.systemd:
        name: chronyd
        state: started
        enabled: true

    - name: Install rsyslog on servers
      ansible.builtin.apt:
        name: rsyslog
        state: present

    - name: Enable and start rsyslog
      ansible.builtin.systemd:
        name: rsyslog
        enabled: true

# ======================================================
# INSTALL DHCP & DNS PACKAGES
# ======================================================
- name: Installing DHCP server
  hosts: dhcp
  become: true
  tasks:
    - name: Install isc-dhcp-server
      ansible.builtin.apt:
        name: isc-dhcp-server
        state: present

- name: Installing DNS server
  hosts: dns
  become: true
  tasks:
    - name: Install bind9
      ansible.builtin.apt:
        name: bind9
        state: present

# ======================================================
# CREATE TSIG KEY (CORRECT & IDEMPOTENT)
# ======================================================
- name: Generate and configure TSIG key on DNS
  hosts: dns
  become: true

  tasks:
    - name: Check if TSIG key exists
      ansible.builtin.stat:
        path: /etc/bind/ddns.key
      register: tsig_stat

    - name: Generate TSIG key (only if missing)
      ansible.builtin.command: tsig-keygen -a hmac-sha256 ddns-key
      register: tsig_output
      when: not tsig_stat.stat.exists

    - name: Save TSIG key to /etc/bind/ddns.key
      ansible.builtin.copy:
        dest: /etc/bind/ddns.key
        content: "{{ tsig_output.stdout }}"
        owner: bind
        group: bind
        mode: "0600"
      when: not tsig_stat.stat.exists

    - name: Read TSIG key
      ansible.builtin.slurp:
        src: /etc/bind/ddns.key
      register: slurped_tsig

    - name: Remove previous DDNS key block
      ansible.builtin.blockinfile:
        path: /etc/bind/named.conf.options
        marker: "# === DDNS KEY BLOCK {mark} ==="
        state: absent

    - name: Insert DDNS key block
      ansible.builtin.blockinfile:
        path: /etc/bind/named.conf.options
        marker: "# === DDNS KEY BLOCK {mark} ==="
        block: "{{ slurped_tsig.content | b64decode }}"
        insertafter: EOF
      notify: restart bind9

  handlers:
    - name: restart bind9
      ansible.builtin.systemd:
        name: bind9
        state: restarted

# ======================================================
# COPY TSIG FROM DNS TO DHCP (CORRECT HANDLING)
# ======================================================
- name: Copy TSIG key from DNS to DHCP
  hosts: dhcp
  become: true
  tasks:
    - name: Fetch TSIG key file from DNS
      ansible.builtin.fetch:
        src: /etc/bind/ddns.key
        dest: /tmp/ddns.key
        flat: true
      delegate_to: dns
      run_once: true

    - name: Transfer TSIG key into DHCP directory
      ansible.builtin.copy:
        src: /tmp/ddns.key
        dest: /etc/dhcp/ddns.key
        owner: root
        group: root
        mode: "0600"
      delegate_to: dhcp
      become: true

# ======================================================
# DNS SERVER CONFIGURATION
# ======================================================
- name: Configure DNS server
  hosts: dns
  become: true
  tasks:
    - name: Configure named.conf.local
      ansible.builtin.copy:
        src: ../files/dns/named.conf.local
        dest: /etc/bind/named.conf.local
        owner: root
        group: bind
        mode: "0640"
        backup: true

    - name: Copy direct zone file
      ansible.builtin.copy:
        src: ../files/dns/db.mario.test
        dest: /var/lib/bind/db.mario.test
        owner: root
        group: bind
        mode: "0644"
        backup: true

    - name: Copy reverse zone file
      ansible.builtin.copy:
        src: ../files/dns/db.192.168.58
        dest: /var/lib/bind/db.192.168.58
        owner: root
        group: bind
        mode: "0644"
        backup: true

    - name: Ensure /var/lib/bind directory permissions
      ansible.builtin.file:
        path: /var/lib/bind
        state: directory
        owner: bind
        group: bind
        mode: "2750"

    - name: Validate named.conf
      ansible.builtin.command: named-checkconf

    - name: Validate direct zone
      ansible.builtin.command: named-checkzone mario.test /var/lib/bind/db.mario.test

    - name: Validate reverse zone
      ansible.builtin.command: named-checkzone 58.168.192.in-addr.arpa /var/lib/bind/db.192.168.58

    - name: Restart and enable bind9
      ansible.builtin.systemd:
        name: bind9
        state: restarted
        enabled: true

# ======================================================
# DHCP SERVER CONFIGURATION
# ======================================================
- name: Configure DHCP server
  hosts: dhcp
  become: true
  tasks:
    - name: Configure network interface for DHCP service
      ansible.builtin.copy:
        src: ../files/dhcp/listen
        dest: /etc/default/isc-dhcp-server
        owner: root
        group: root
        mode: "0644"
        backup: true

    - name: Configure dhcpd.conf
      ansible.builtin.copy:
        src: ../files/dhcp/dhcpd.conf
        dest: /etc/dhcp/dhcpd.conf
        owner: root
        group: root
        mode: "0644"
        backup: true

    - name: Validate dhcpd.conf
      ansible.builtin.command: dhcpd -t -cf /etc/dhcp/dhcpd.conf

    - name: Restart and enable DHCP server
      ansible.builtin.systemd:
        name: isc-dhcp-server
        state: restarted
        enabled: true

# ======================================================
# CLIENT C1 â€” REQUEST DHCP IP
# ======================================================
- name: Request IP for client c1
  hosts: c1
  become: true
  tasks:
    - name: Bring network interface up
      ansible.builtin.command: ip link set eth1 up
      ignore_errors: false

    - name: Release current IP (if any)
      ansible.builtin.command: dhclient -r eth1
      ignore_errors: true

    - name: Remove old DHCP leases
      ansible.builtin.file:
        path: /var/lib/dhcp/dhclient.leases
        state: absent

    - name: Request new DHCP IP
      ansible.builtin.command: dhclient -v eth1
      register: dhclient_output

    - name: Show DHCP negotiation details
      ansible.builtin.debug:
        var: dhclient_output.stdout

    - name: Show assigned IP
      ansible.builtin.command: ip a
      register: ip_output

    - name: Display obtained IP
      ansible.builtin.debug:
        var: ip_output.stdout