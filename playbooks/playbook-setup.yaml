---
# ======================================================
# GLOBAL CONFIGURATION
# ======================================================
- name: Configuring time-zone and .log
  hosts: all
  become: true
  tasks:
    - name: Synchronize system time
      ansible.builtin.command: timedatectl set-timezone Europe/Madrid
      changed_when: false

    - name: Ensure system clock is synchronized
      ansible.builtin.apt:
        name: chrony
        state: present
        update_cache: true

    - name: Start and enable chrony
      ansible.builtin.systemd:
        name: chronyd
        state: started
        enabled: true

    - name: Install rsyslog
      when: inventory_hostname in ["server"]
      ansible.builtin.apt:
        name: rsyslog
        state: present
        update_cache: true

    - name: Enable and start rsyslog service
      when: inventory_hostname in ["server"]
      ansible.builtin.systemd:
        name: rsyslog
        enabled: true
# ======================================================
# SERVERS CONFIGURATION
# ======================================================
- name: Configuring servers
  hosts: all
  become: true
  tasks:
    - name: Changing DNS # a√±adimos servidor de google para poder resovler los dominios de la instalacion de paquetes
      when: inventory_hostname in ["servers"]
      ansible.builtin.copy:
        src: ../files/resolv.conf
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: "0644" # permisos en octal
        backup: true

# ======================================================
# DHCP SERVER CONFIGURATION
# ======================================================
- name: Configuring DHCP server
  hosts: all
  become: true
  tasks:
  
    - name: Updating and installing
      when: inventory_hostname in ["servers"]
      ansible.builtin.apt:
        update_cache: true # Actualizar
        name: isc-dhcp-server
        state: present

    - name: Configuring listen network adapter
      when: inventory_hostname == "dhcp"
      ansible.builtin.copy:
        src: ../files/dhcp/listen
        dest: /etc/default/isc-dhcp-server
        owner: root
        group: root
        mode: "0644" # permisos en octal
        backup: true

    - name: Configuring configuration file dhcpd.conf
      when: inventory_hostname == "dhcp"
      ansible.builtin.copy:
        src: ../files/dhcp/dhcpd.conf
        dest: /etc/dhcp/dhcpd.conf
        owner: root
        group: root
        mode: "0644"
        backup: true

    - name: Enabling the service
      when: inventory_hostname == "dhcp"
      ansible.builtin.systemd:
        name: isc-dhcp-server
        enabled: true

    - name: Restarting the service
      when: inventory_hostname == "dhcp"
      ansible.builtin.systemd:
        name: isc-dhcp-server
        state: restarted

# ======================================================
# DNS SERVER CONFIGURATION
# ======================================================
- name: Configuring DNS server
  hosts: all
  become: true
  tasks:
    - name: Updating and installing
      when: inventory_hostname in ["dns"]
      ansible.builtin.apt:
        update_cache: true # Actualizar
        name: bind9 
        state: present

    - name: Configuring local zones file
      when: inventory_hostname == "dns"
      ansible.builtin.copy:
        src: ../files/dns/named.conf.local
        dest: /etc/bind/named.conf.local
        owner: root
        group: bind
        mode: "0622" #  I have taken the file from the last exercise as an example.
        backup: true

    - name: Configuring direct zone file 
      when: inventory_hostname == "dns"
      ansible.builtin.copy:
        src: ../files/dns/db.mario.test
        dest: /var/lib/bind/db.mario.test
        owner: root
        group: bind
        mode: "0622"
        backup: true

    - name: Configuring reverse zone file 
      when: inventory_hostname == "dns"
      ansible.builtin.copy:
        src: ../files/dns/db.127
        dest: /var/lib/bind/db.127
        owner: root
        group: bind
        mode: "0622"
        backup: true


    - name: Enabling the service
      when: inventory_hostname == "dns"
      ansible.builtin.systemd:
        name: bind9
        enabled: true

    - name: Restarting the service
      when: inventory_hostname == "dns"
      ansible.builtin.systemd:
        name: bind9
        state: restarted

